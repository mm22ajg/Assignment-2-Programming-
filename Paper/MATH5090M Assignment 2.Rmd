---
title: "Evaluating the BOP2 design"
author: "Adam Gough (201612804)"
date: '2023-03-07'
output:
  html_document: default
  pdf_document: default
---

## Introduction

The RESERVE clinical trial studies the efficacy of a particular treatment on patients with relapsed/refractory multiple myeloma (RRMM), a type of bone marrow cancer. RESERVE is a type II clinical trial meaning we are investigating whether or not the patients respond to our treatment. This is important as patients with RRMM have previously been unresponsive to treatment. For safety, we want to be able to stop the trial early if it is clear the treatment is not working. To do this, we will implement the BOP2 (Bayesian optimal phase II) clinical trial design. This report aims to apply the BOP2 design in this scenario, and then evaluate how the result changes based on the prior distribution.

## The BOP2 design

We will begin with a description of the Bayesian optimal phase II (BOP2) design. Consider the following trial structure:

1.  Stage 1: Recruit $n_1$ patients and monitor their response to treatment.

2.  Based on the data obtained from stage 1, determine whether to continue the trial.

3.  Stage 2: Recruit further $\tilde{n}_2$ patients and monitor their response to treatment.

4.  Based on the full set of data containing $n_2=n_1+\tilde{n}_2$ patients, determine whether to continue to a phase III trial where we would compare the treatment to the current standard.

At each stage, we have a fixed number of patients, each with the same probability of responding to treatment, labelled $\theta$. Also, patient outcomes are independent of each other. Therefore, by the end of stage $i$, the number of patients who have responded to treatment $y_i$ is Binomially distributed, $$y_i\mid\theta\sim Bin(n_i,\theta)$$

Taking a Bayesian approach, we can attain the posterior distribution for $\theta$ by using the conjugate prior distribution $\theta\sim Beta(a,b)$ and applying Bayes' theorem. We find,$$\theta\mid y_i\sim Beta(a+y_i,b+(n_i-y_i))$$

Now consider the posterior probability of futility, i.e., the probability the patients are not responding to the treatment given the data. In mathematical terms, this can be expressed as $Pr(\theta<0.5\mid y_i)$. To decide whether to continue the trial at each stage, we can assess whether this probability is above a threshold value. The BOP2 design specifies that the threshold at each stage is given by,$$C(n_i)=1-\lambda\left(\frac{n_i}{n_2}\right)^\gamma$$

Here, $\lambda$ and $\gamma$ are called the stopping rule parameters. We restrict ourselves to $0\le\lambda\le1$ and $\gamma>0$. This ensures that $C(n_2)<C(n_1)$, indicating the threshold is more demanding at the end of stage 2, and it is more challenging to progress.

Contemplate a hypothesis test for $\theta$ where $\theta_0$ and $\theta_1$ denote the null and alternative hypotheses, respectively. Then we can define the type I error rate as the probability of continuing the trial at the end of stage 2 under the null hypothesis, and the type II error rate as the probability of stopping the trial at either stage under the alternative hypothesis.

We can now optimise the trial design by finding the stopping rule and sample size parameters which minimise the expected sample size, subject to the type I and II error rates being below specified probabilities.

## Application

Now we can implement the BOP2 clinical trial design in R. Here $\theta_0=0.5$ and $\theta_1=0.7$. We want to minimise the expected sample size subject to the type I error rate being at most $0.05$ and the type II error rate being at most $0.2$. For the prior distribution we will begin by using $a=0.5$ and $b=0.5$. We need to program two functions which are capable of calculating the expected sample size and the error rates.

```{r include=FALSE}
test_prob_y <- function(a, b) {
  # Check that the probabilities sum to 1.
  n <- 30
  s <- sum(prob_y(0:n, n, a, b))
  return(all.equal(s, 1))
}
```

```{r echo=TRUE}
prob_y <- function(y, n, a, b) {
  # Calculate the probability of observing y responses in n trials
  # under a Beta-binomial model with Beta(a, b) prior.
  
  choose(n, y) * beta(y + a, n - y + b) / beta(a, b)
}

test_prob_y(a = 0.5, b = 0.5)

expected_sample_size <- function(lambda, gamma, n1, n2, a, b) {
  
  # Calculate the expected sample size of a BOP2 design defined by its 
  # decision rule parameters (lambda, gamma), sample size parameters 
  # (n1, n2), and prior distribution parameters (a, b)
  
  # Threshold to determine progression.
  C1 <- 1 - lambda * (n1 / n2)^gamma
  
  # Vector of possible stage 1 outcomes.
  y_1s <- 0:n1
  
  # Vector of corresponding progression decisions.
  stops <- pbeta(0.5, y_1s + a, n1 - y_1s + b) > C1
  
  # Calculate the probability of each outcome.
  y_1_probs <- prob_y(y_1s, n1, a, b)
  
  return(sum(n1 * stops * y_1_probs + n2 * (!stops) * y_1_probs))
}

prob_y1_and_y2 <- function(y_1, y_2, n1, n2, theta) {
  
  # Calculate the probability of observing y_1 and y_2 given theta.
  dbinom(y_1, n1, theta)*dbinom(y_2, n2 - n1, theta)
}

error_rates <- function(lambda, gamma, n1, n2, a, b) {
  
  # Calculate the type I and type II error rates of a BOP2 design defined 
  # by its decision rule parameters (lambda, gamma), sample size 
  # parameters (n1, n2), and prior distribution parameters (a, b).
  
  # Thresholds to determine progression.
  C1 <- 1 - lambda * (n1 / n2)^gamma
  C2 <- 1 - lambda * (n2 / n2)^gamma
  
  # Matrix of possible successes in stage 1 and 2.
  ys <- expand.grid(y_1 = 0:n1, y_2 = 0:(n2 - n1))
  
  # Vectors of corresponding progression decisions at stage 1 and 2.
  go_1 <- pbeta(0.5, ys$y_1 + a, n1 - ys$y_1 + b) < C1
  go_2 <- pbeta(0.5, ys$y_1 + ys$y_2 + a, n2 - ys$y_1 - ys$y_2 + b) < C2
  
  # Vectors of overall progression decisions.
  go_tI <- go_1 & go_2
  go_tII <- !go_1 | !go_2
  
  # Calculate the probability of each outcome.
  probs_tI <- prob_y1_and_y2(ys$y_1, ys$y_2, n1, n2, 0.5)
  probs_tII <- prob_y1_and_y2(ys$y_1, ys$y_2, n1, n2, 0.7)
  
  # Calculate the type I and type II error rates.
  type_I <- sum(go_tI*probs_tI)
  type_II <- sum(go_tII*probs_tII)
  
  return(c(type_I,type_II))
}
```

The code above outputs `TRUE` here as we have utilised a unit test to ensure that the probabilities from the function `prob_y` sum to 1. Notice that these functions also depend on the prior distribution parameters $a$ and $b$. This will be useful when we change how informative the prior distribution is. Now we can use a grid search to find the parameters $\lambda$, $\gamma$, $n_1$, and $n_2$ which minimise the expected sample size subject to our constraints.

```{r echo=TRUE}
BOP2optim <- function(a, b){
  
  # Minimise the expected sample size of a BOP2 design subject to the
  # type I error rate being at most 0.05 and the type II error rate being at most
  # 0.2 using a grid search.
  
  # Create a grid of possible parameter values.
  grid <- expand.grid(lambda = seq(0,1,0.05), gamma = seq(0.05,2,0.05), n1 = seq(4, 20, 4), n2 = seq(5, 80, 5))
  grid <- grid[grid$n1<=grid$n2,]
  
  # Initialise vectors.
  res <- c(max(grid[,4]),0,0)
  
  # Search over the grid for the minimum expected sample size and record the 
  # corresponding parameters.
  for(i in 1:nrow(grid)){
    exp_s_s <- expected_sample_size(grid[i,1],grid[i,2],grid[i,3],grid[i,4], a = a, b = b)
    err_rts <- error_rates(grid[i,1],grid[i,2],grid[i,3],grid[i,4], a = a, b = b)
    if(exp_s_s < res[1] & err_rts[1] <= 0.05 & err_rts[2] <= 0.2){
      res <- c(exp_s_s,err_rts[1],err_rts[2])
      val <- grid[i,]
    }
  }
  
  #Return the minimised expected sample size, error rates and corresponding parameters.
  print(val)
  print(res)
}

# Optimise the BOP2 design when a = 0.5 and b = 0.5, and record the time elapsed.
ptm <- proc.time()
BOP2optim(a = 0.5, b = 0.5)
proc.time() - ptm
```

The minimum expected sample size found by the algorithm is 27.657. This is achieved when $\lambda=0.95$, $\gamma=0.9$, $n_1=8$, and $n_2=40$. The algorithm took over one minute to run which is very poor considering the precision of our parameter estimates is $\pm0.025$, $\pm0.025$, $\pm2$, and $\pm2.5$, respectively.

## Evaluation

In the above implementation of the BOP2 clinical trial design we have used $\theta\sim Beta(0.5, 0.5)$ as a prior distribution for $\theta$. Below is the corresponding probability density function.

```{r echo=FALSE}
x <- seq(0, 1, length = 1000)
y <- dbeta(x, shape1 = 0.5, shape2 = 0.5)
plot(x, y, type = "l", xlab = expression(theta), ylab = "PDF", main = 'Beta(0.5,0.5)')
```

We can see that the distribution is symmetric about 0.5, and indeed we have $Pr(\theta<0.5)=Pr(\theta\ge0.5)=0.5$, Additionally, $E[\theta]=0.5$. This gives us no information on whether we think patients will respond to treatment prior to our clinical trial. We will now consider two cases. In Case 1, suppose we are more certain that the patients will not respond to treatment. In Case 2, suppose we are more certain that the patients will respond to treatment. We can express these prior beliefs in Case 1 and Case 2 as the following distributions: $\theta_1\sim Beta(a_1=2,b_1=5)$ and $\theta_2\sim Beta(a_2=5,b_2=2)$. Below are the corresponding probability density functions.

```{r echo=FALSE}
par(mfrow=c(1,2))
x <- seq(0, 1, length = 1000)
pdf_1 <- dbeta(x, shape1 = 2, shape2 = 5)
pdf_2 <- dbeta(x, shape1 = 5, shape2 = 2)
plot(x, pdf_1, type = "l", xlab = expression(theta), ylab = "PDF", main = "Case 1 - Beta(2,5)")
plot(x, pdf_2, type = "l", xlab = expression(theta), ylab = "PDF", main = "Case 2 - Beta(5,2)")
```

Now we have that $E[\theta_1]=\frac{2}{7}\approx0.286$ and $E[\theta_2]=\frac{5}{7}\approx0.714$. We can now optimise again, but this time using our new prior distributions. Starting with Case 1,

```{r}

```
